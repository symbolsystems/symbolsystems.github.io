<HTML>
<HEAD>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<LINK REL="stylesheet" HREF="book.css" TYPE="text/css">
<TITLE>
Do not use in preprocessor directives #if and #elif macros not defined in translation unit [MISRACPP2023-19_1_3-a]
</TITLE>
</HEAD>
<BODY BGCOLOR=#FFFFFF>
<STRONG>
Do not use in preprocessor directives #if and #elif macros not defined in translation unit [MISRACPP2023-19_1_3-a-2]
</STRONG>
<BR><BR>
<STRONG>
DESCRIPTION
</STRONG>
<PRE>

"If an attempt is made to use an identifier in a preprocessor directive,
and that identifier has not been defined, the preprocessor will sometimes
not give any warning but will assume the value zero. 
'#ifdef', '#ifndef' and 'defined()' are provided to test the existence
of a macro, and are therefore excluded.

Note that preprocessing identifiers may be defined either by use of #define
directives or by options specified at compiler invocation. However the use
of the #define directive is preferred." [MISRA C:2004 Rule 19.11]

The violation is reported by the rule if the macro identifier is used
in #if/#elif directive (except as operands to the 'defined' operator)
and it is possible the macro is not defined. 

No violation is reported if in other files in current translation unit there is
a #define for that macro or a check if the macro is defined or not.

Please see Notes section for detailed description of the above algorithm.

See also: MISRA2004-19_11



</PRE>
<STRONG>
SINCE
</STRONG>
<PRE>

v9.5



</PRE>
<STRONG>
NOTES
</STRONG>
<PRE>

The rule assumes that macro identifier is defined in current file only if:

1. it was previously defined via #define directive. The definition must be
   unconditional. For example:
   #ifdef UNIX
   #  define MACRO1 1
   #  define MACRO2 2
   #else
   #  define MACRO1 -1
   #endif
   /* MACRO1 is defined, MACRO2 is assumed to be not defined */

2. or if it is used in context of preprocessor directive #ifdef, #ifndef, #if, 
   or #elif which checks if the macro identifier was previously defined.
   For example:
   #ifdef MACRO
      /* MACRO is defined */
   #endif

In both cases the #define or #ifdef (or similar) checks must be in the same
file as the macro use.

If the above algorithm detects that macro M is undefined in current file, then 
other files in current translation unit are scanned for #define M, #ifndef M,
#ifdef M, and #if ... defined(M) directives. A violation is reported only if
no such directive is found. For example:
   /* header.h */
   #ifdef UNIX
   #  define M 1
   #endif
   /* source.c */
   #include "header.h"
   #if M &gt; 0 /* The macro M is detected to be not defined in source.c file at
                this point, but no violation is reported because a "#define M"
                was found in one of other files in this translation unit */
   #endif



</PRE>
<STRONG>
BENEFITS
</STRONG>
<PRE>

The rule prevents using undefined macros in #if and #elif directives, which may
be undetected if the preprocessor does not give any warnings.



</PRE>
<STRONG>
DRAWBACKS
</STRONG>
<PRE>

1. Logical expressions in #if/#elif are not supported. For example:
   #if defined(MACRO) &amp;&amp; MACRO &gt; 0 /* MACRO is assumed to be not defined and */
   #endif                          /* a violation will be reported */
   #if defined(MACRO1) &amp;&amp; !defined(MACRO2)
   /* Both MACRO1 and MACRO2 are assumed to be not defined and usage of those */
   /* macros will result in a violation */
   #endif

2. Only simple analysis of control flow is performed. For example:
   #define MACRO1
   #ifdef MACRO1
   #define MACRO2
   #endif
   /* MACRO2 is assumed to be undefined */

3. Predefined and command line macros are not supported and any use of such
   macros must be preceded with checking if they are defined.

4. The rule only scans for presence of #define, #ifdef, #ifndef, #if defined()
   in other files, but does not actually check if the macro was really defined.
   For example:
   /* header1.h */
   #ifndef M1
   #  define M2 1
   #endif

   /* header2.h */
   #define M3 1

   /* source.c */
   #include "header1.h"
   #if M1 &gt; 0 /* No violation reported - #ifndef M1 was found in other files */
   #endif
   #if M2 &gt; 0 /* No violation reported - #define M2 was found in other files */
   #endif
   #if M3 &gt; 0 /* No violation reported - #define M3 was found in other files */
   #endif
   #include "header2.h"



</PRE>
<STRONG>
EXAMPLE
</STRONG>
<PRE>

#if M &gt; 0        /* Violation - macro was not defined */
#endif

#define M 1
#undef M
#if M &gt; 0        /* Violation - macro was undefined before the use */
#endif

#ifdef X
  #define M 1
#endif
#if M &gt; 0        /* Violation - macro was defined conditionally */
#endif

#if defined(M) &amp;&amp; M &gt; 0  /* Violation - logical expressions are not supported */
#endif

#if defined(M) &amp;&amp; defined(N)  /* Logical expressions are not supported */
  #if M &gt; 0                   /* Violation */
  #endif
#endif

#if defined(Q)
  #define M 1
#elif defined(R)
  #define M 2
#endif
#if M &gt; 1   /* Violation - macro was defined conditionally */
#endif



</PRE>
<STRONG>
REPAIR
</STRONG>
<PRE>

#define M1 1

#if M1 &gt; 0        /* OK - macro was defined */
#endif

#undef M1

#ifdef M1
  #if M1 &gt; 0      /* OK - macro is used only if it was defined */
  #endif
#endif

#ifndef M1
//...
#else
  #if M1 &gt; 0      /* OK - macro is used only if it was defined */
  #endif
#endif

#if defined(Q)
  #define M1 1
#elif defined(R)
  #define M1 2
#else
  #define M1 3
#endif
#if M1 &gt; 1   /* OK - macro was defined unconditionally */
#endif

#ifndef M2
#error M2 is not defined
#endif
#if M2 &gt; 0 /* OK - #error directive breaks preprocessing if M2 is not defined */
#endif

#if !defined(M3)
#define M3 1
#endif
#if M3 &gt; 1   /* OK - M3 must be defined */
#endif

/* header.h: */
#define M4 1
#ifndef M5
#if defined(M6)
#endif
#endif
/* source.c: */
#include "header.h"
#if M4 &gt; 1  /* OK - there is #define M4 in header.h */
#endif
#if M5 &gt; 1  /* OK - there is #ifndef M5 in  header.h */
#endif
#if M6 &gt; 1  /* OK - there is #if defined(M6) in header.h */
#endif



</PRE>
<STRONG>
REFERENCES
</STRONG>
<PRE>

1. AUTOSAR C++14 Coding Guidelines
   M16-0-7. Undefined macro identifiers shall not be used in #if or #elif pre-
   processor directives, except as operands to the defined operator

2. MISRA C++:2008 Guidelines for the use of the C++ language in critical
   systems, Chapter 6, Section 16, Rule 16-0-7

3. MISRA C++:2023 Guidelines for the use of C++17 in critical systems
   Rule 19.1.3 All identifiers used in the controlling expression of #if or #elif preprocessing directives shall be defined prior to evaluation

4. MISRA C:2012 Guidelines for the use of the C language in critical systems
   Section 8: Rules, Rule 20.9

5. MISRA-C:2004 Guidelines for the use of the C language in critical systems
   Chapter 6, Section 19

6. Origin: Misra Guidelines - Rule 97

</PRE>
</BODY>
</HTML>
